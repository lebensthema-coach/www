name: Automated PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install -g @githubnext/github-copilot-cli
          npm install -g markdownlint-cli
          npm install -g htmlhint

      - name: Code Quality Checks
        run: |
          echo "## üîç Code Quality Analysis" >> $GITHUB_STEP_SUMMARY
          
          # Check for HTML files
          if find . -name "*.html" -type f | grep -q .; then
            echo "### HTML Files Found" >> $GITHUB_STEP_SUMMARY
            find . -name "*.html" -type f -exec echo "- {}" \; >> $GITHUB_STEP_SUMMARY
            
            # HTML validation
            echo "### HTML Validation" >> $GITHUB_STEP_SUMMARY
            for file in $(find . -name "*.html" -type f); do
              echo "Checking $file..." >> $GITHUB_STEP_SUMMARY
              htmlhint "$file" >> $GITHUB_STEP_SUMMARY 2>&1 || true
            done
            
            # Check for specific HTML issues
            echo "### HTML Structure Issues" >> $GITHUB_STEP_SUMMARY
            for file in $(find . -name "*.html" -type f); do
              echo "**File**: $file" >> $GITHUB_STEP_SUMMARY
              
              # Check for missing closing tags
              if ! grep -q "</head>" "$file"; then
                echo "‚ùå **CRITICAL**: Missing closing </head> tag" >> $GITHUB_STEP_SUMMARY
              fi
              
              if ! grep -q "</body>" "$file"; then
                echo "‚ùå **CRITICAL**: Missing closing </body> tag" >> $GITHUB_STEP_SUMMARY
              fi
              
              # Check for images without alt text
              if grep -q "<img" "$file" && ! grep -q "alt=" "$file"; then
                echo "‚ùå **ACCESSIBILITY**: Images without alt attributes" >> $GITHUB_STEP_SUMMARY
              fi
              
              # Check for inline styles
              if grep -q 'style=' "$file"; then
                echo "‚ö†Ô∏è **PERFORMANCE**: Inline styles detected - consider moving to CSS" >> $GITHUB_STEP_SUMMARY
              fi
              
              # Check for external scripts without integrity
              if grep -q 'src="http' "$file"; then
                echo "‚ùå **SECURITY**: External scripts without integrity checks" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
          
          # Check for CSS
          if find . -name "*.css" -type f | grep -q .; then
            echo "### CSS Files Found" >> $GITHUB_STEP_SUMMARY
            find . -name "*.css" -type f -exec echo "- {}" \; >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for JavaScript
          if find . -name "*.js" -type f | grep -q .; then
            echo "### JavaScript Files Found" >> $GITHUB_STEP_SUMMARY
            find . -name "*.js" -type f -exec echo "- {}" \; >> $GITHUB_STEP_SUMMARY
          fi

      - name: Security Scan
        run: |
          echo "## üîí Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "### Security Checklist:" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No hardcoded secrets or API keys" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No external CDN dependencies without integrity checks" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No inline scripts without proper CSP" >> $GITHUB_STEP_SUMMARY
          
          # Check for potential security issues
          echo "### Security Issues Found:" >> $GITHUB_STEP_SUMMARY
          
          # Check for hardcoded API keys
          if grep -r "sk-[a-zA-Z0-9]" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ùå **CRITICAL SECURITY**: Hardcoded API keys found!" >> $GITHUB_STEP_SUMMARY
            grep -r "sk-[a-zA-Z0-9]" . --exclude-dir=.git --exclude-dir=node_modules >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for HTTP URLs
          if grep -r "http://" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ùå **SECURITY**: HTTP URLs detected - use HTTPS" >> $GITHUB_STEP_SUMMARY
            grep -r "http://" . --exclude-dir=.git --exclude-dir=node_modules >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for inline scripts
          if grep -r "<script>" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è **SECURITY**: Inline scripts detected - consider CSP" >> $GITHUB_STEP_SUMMARY
            grep -r "<script>" . --exclude-dir=.git --exclude-dir=node_modules >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for external scripts without integrity
          if grep -r 'src="http' . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ùå **SECURITY**: External scripts without integrity checks" >> $GITHUB_STEP_SUMMARY
            grep -r 'src="http' . --exclude-dir=.git --exclude-dir=node_modules >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for other secrets
          if grep -r "password\|secret\|key\|token" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md"; then
            echo "‚ö†Ô∏è **Warning**: Potential secrets found in code" >> $GITHUB_STEP_SUMMARY
            grep -r "password\|secret\|key\|token" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ No obvious secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Performance Analysis
        run: |
          echo "## ‚ö° Performance Analysis" >> $GITHUB_STEP_SUMMARY
          echo "### Performance Checklist:" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Images are optimized" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] CSS is minified for production" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] JavaScript is optimized" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No blocking resources" >> $GITHUB_STEP_SUMMARY
          
          # Check file sizes
          echo "### File Size Analysis:" >> $GITHUB_STEP_SUMMARY
          find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) -exec ls -lh {} \; | awk '{print "- " $9 ": " $5}' >> $GITHUB_STEP_SUMMARY
          
          # Check for performance issues
          echo "### Performance Issues Found:" >> $GITHUB_STEP_SUMMARY
          
          # Check for large base64 images
          if grep -r "data:image" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ùå **PERFORMANCE**: Large base64 images detected" >> $GITHUB_STEP_SUMMARY
            grep -r "data:image" . --exclude-dir=.git --exclude-dir=node_modules >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for inline styles
          if grep -r 'style=' . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è **PERFORMANCE**: Inline styles detected - consider CSS files" >> $GITHUB_STEP_SUMMARY
            grep -r 'style=' . --exclude-dir=.git --exclude-dir=node_modules >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for external resources
          if grep -r 'href="http' . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è **PERFORMANCE**: External resources without integrity" >> $GITHUB_STEP_SUMMARY
            grep -r 'href="http' . --exclude-dir=.git --exclude-dir=node_modules >> $GITHUB_STEP_SUMMARY
          fi

      - name: Accessibility Check
        run: |
          echo "## ‚ôø Accessibility Analysis" >> $GITHUB_STEP_SUMMARY
          echo "### Accessibility Checklist:" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Alt text for images" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Proper heading hierarchy" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Color contrast meets WCAG standards" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Keyboard navigation support" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Screen reader compatibility" >> $GITHUB_STEP_SUMMARY
          
          # Check for accessibility issues
          echo "### Accessibility Issues Found:" >> $GITHUB_STEP_SUMMARY
          
          # Check for images without alt text
          if find . -name "*.html" -type f -exec grep -l "<img" {} \; | xargs grep -L "alt="; then
            echo "‚ùå **ACCESSIBILITY**: Images without alt attributes found" >> $GITHUB_STEP_SUMMARY
            find . -name "*.html" -type f -exec grep -l "<img" {} \; | xargs grep -L "alt=" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All images have alt attributes" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for poor color contrast
          if grep -r "color: #999" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ùå **ACCESSIBILITY**: Poor color contrast detected (#999)" >> $GITHUB_STEP_SUMMARY
            grep -r "color: #999" . --exclude-dir=.git --exclude-dir=node_modules >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for heading hierarchy issues
          if grep -r "<h3>" . --exclude-dir=.git --exclude-dir=node_modules && grep -r "<h2>" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è **ACCESSIBILITY**: Heading hierarchy issue - H3 before H2" >> $GITHUB_STEP_SUMMARY
            grep -r "<h[2-3]>" . --exclude-dir=.git --exclude-dir=node_modules >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate Review Summary
        run: |
          echo "## üìã Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Automated Review Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Review Status**: ‚úÖ Automated checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the analysis above" >> $GITHUB_STEP_SUMMARY
          echo "2. Address any warnings or issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Request human review if needed" >> $GITHUB_STEP_SUMMARY
          echo "4. Merge when ready" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ü§ñ **Automated PR Review Complete**\n\n${summary}`
            });
